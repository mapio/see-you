#!/bin/bash

exercise_dir=/Users/santini/Documents/SCM/teaching/labprog.temi
exercises='salve_mondo'

export PYTHONPATH=/Users/santini/x/tristo-mietitore

tempdir=$(mktemp -d /tmp/vulcano-XXXXXXXXX) || exit 1

echocol() { echo -e "\033[31m$@\033[0m"; }

echocol "Preparing base conf files..."

cat > $tempdir/uids.tsv <<EOF
123	First Name
456	Second Name
EOF

cat > $tempdir/vulcano-base.py <<EOF
SECRET_KEY = 'a very long secret'
MAX_CONTENT_LENGTH = 16 * 1024 * 1024
LANG = 'it'
EEG_HOME = '/tmp/vulcano_test/home'
UPLOAD_DIR = '/tmp/vulcano_test/uploads'
ENVIRONMENT_SETUP = """
export PATH="{0}/bin":\$PATH
export MAKEFILES="{0}/Makefile"
"""
EOF

cat > $tempdir/minosse-base.py <<EOF
EVAL_COMMAND = './valuta'
EOF

echocol "Preparing tm tar directoroy..."

mkdir $tempdir/bundle
n=1
for e in $exercises; do
	cp -r $exercise_dir/$e $tempdir/bundle/esercizio-$n
	n=$(( n + 1 ))
done

echocol "Making test files..."

. ./set_makefiles
make -wC $tempdir/bundle revals
rm -f $tempdir/bundle/*/{soluzione*,*.[ch]}

echocol "Adding readme and bins..."

cp ./LEGGIMI.txt $tempdir/bundle/LEGGIMI.txt
cp ./Makefile-student $tempdir/bundle/Makefile
mkdir $tempdir/bundle/bin
cp ./bin/{consegna,identifica} $tempdir/bundle/bin

echocol "Generating tm conf file..."

filter='^(bin/.*|Makefile|LEGGIMI.txt|esercizio-[0-9]+/(Testo|(input|output|args)-[0-9]+)\.txt)$'
python -m tm.mkconf -vf "$filter" tm_conf.py $tempdir/vulcano-base.py $tempdir/bundle $tempdir/uids.tsv

echocol "Generating minosse configuration..."

rm -rf $tempdir/bundle/{Makefile,bin,LEGGIMI.txt}
cp ./Makefile-student $tempdir/bundle/Makefile-student
cp ./Makefile-teacher $tempdir/bundle/Makefile-teacher
cp ./bin/valuta $tempdir/bundle/valuta

filter='^(valuta|Makefile.*|(esercizio-[0-9]+/(input|output|args)-.+\.txt))$'
python -m tm.mkconf -vf "$filter" minosse_conf.py $tempdir/minosse-base.py $tempdir/bundle


rm -rf $tempdir
