#!/bin/bash

echocol() { echo -e "\033[31m$@\033[0m"; }

srcdir="$1"

if [ ! -d "$srcdir" ]; then
	echo "Specify the source dir parameter"
	exit 1
fi

if [ ! -d "$EXERCISES_DIR" ]; then
	echo "Please set EXERCISES_DIR"
	exit 1
fi

export PYTHONPATH=/Users/santini/Documents/SCM/programming/eeg/tristo-mietitore
export SUPPORT="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )/support"
export MAKEFILES="$SUPPORT/Makefile-student $SUPPORT/Makefile-teacher"

tempdir=$(mktemp -d /tmp/vulcan-XXXXXXXXX) || exit 1

echocol "Preparing tm tar directoroy..."

mkdir $tempdir/bundle
n=1
echo -n "Adding exercises:  "
for e in $(cat "$srcdir/exercises.txt"); do
	dst=$tempdir/bundle/esercizio-$n
	mkdir $dst
	cp "$EXERCISES_DIR/$e"/{*.[ch],*.txt} $dst
	n=$(( n + 1 ))
done
echo

echocol "Making test files..."

make -wC $tempdir/bundle revals
rm -f $tempdir/bundle/*/{soluzione*,*.[ch]}

echocol "Adding readme and bins..."

cp $SUPPORT/LEGGIMI.txt $tempdir/bundle/LEGGIMI.txt
cp $SUPPORT/Makefile-student $tempdir/bundle/Makefile
mkdir $tempdir/bundle/bin
cp $SUPPORT/bin/{consegna,identifica} $tempdir/bundle/bin

echocol "Generating tm conf file..."

cat "$srcdir/base-tm.py" > $tempdir/base-tm.py
cat >> $tempdir/base-tm.py <<EOF
ENVIRONMENT_SETUP = """
export PATH="### tm_home ###/bin":\$PATH
export MAKEFILES="### tm_home ###/Makefile"
"""
EOF
filter='^(bin/.*|Makefile|LEGGIMI.txt|esercizio-[0-9]+/(Testo|(input|output|args)-[0-9]+)\.txt)$'
chmod -R u+rX-w,go= $tempdir/bundle
find $tempdir/bundle -type d -exec chmod u+w {} \;
python -m tm.mkconf -vf "$filter" tm-conf.py $tempdir/base-tm.py $tempdir/bundle "$srcdir/registered_uids.tsv"
chmod -R u+rwX,go= $tempdir/bundle

echocol "Generating minos configuration..."

rm -rf $tempdir/bundle/{Makefile,bin,LEGGIMI.txt}
cp $SUPPORT/Makefile-student $tempdir/bundle/Makefile-student
cp $SUPPORT/Makefile-teacher $tempdir/bundle/Makefile-teacher
cp $SUPPORT/bin/valuta $tempdir/bundle/valuta

cat "$srcdir/base-minos.py" > $tempdir/base-minos.py
cat >> $tempdir/base-minos.py <<EOF
EVAL_COMMAND = './valuta'
EOF
filter='^(valuta|Makefile.*|(esercizio-[0-9]+/(input|output|args)-.+\.txt))$'
chmod -R u+rX-w,go= $tempdir/bundle
python -m tm.mkconf -vf "$filter" minos-conf.py  $tempdir/base-minos.py $tempdir/bundle

chmod -R u+rwX,go= $tempdir
rm -rf $tempdir
