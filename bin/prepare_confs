#!/bin/bash -e

echocol() { echo -e "\033[31m$@\033[0m"; }

srcdir="$1"

if [ ! -d "$srcdir" ]; then
	echo "Specify the source dir parameter"
	exit 1
fi
# srcdir="${srcdir%%[/]*}" FIND A WAY TO REMOVE JUST THE TRAILING /

if [ ! -d "$EXERCISES_DIR" ]; then
	echo "Please set EXERCISES_DIR"
	exit 1
fi

export PYTHONPATH=/Users/santini/Documents/SCM/programming/eeg/tristo-mietitore
export SUPPORT="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )/support"

tempdir=$(mktemp -d /tmp/vulcan-XXXXXXXXX) || exit 1

echocol "*** Preparing TM tar directoroy..."

echocol "Adding exercises..."

mkdir $tempdir/bundle
n=1
for e in $(cat "$srcdir/exercises.txt"); do
	dst=$tempdir/bundle/esercizio-$n
	mkdir $dst
	cp "$EXERCISES_DIR/$e"/{*.[ch],*.txt} $dst
	n=$(( n + 1 ))
done

echocol "Making test files (and removing the solution source code)..."

MAKEFILES="$SUPPORT/Makefile $SUPPORT/Makefile-prepare" make -wC $tempdir/bundle routs
rm -f $tempdir/bundle/*/{soluzione*,*.[ch]}

echocol "Adding readme and bins..."

cp $SUPPORT/LEGGIMI.txt $tempdir/bundle/LEGGIMI.txt
mkdir $tempdir/bundle/bin
cp $SUPPORT/Makefile $SUPPORT/bin/{consegna,identifica} $tempdir/bundle/bin

echocol "Fixing perms..."

chmod -R u+rX-w,go= $tempdir/bundle
find $tempdir/bundle -name esercizio-\* -type d -exec chmod u+w {} \;

echocol "*** Generating the TM configuration file (base + tar + uids)..."

cat "$srcdir/conf.py" > $tempdir/conf.py
cat >> $tempdir/conf.py <<EOF

CLIENT = '$HOME/.tm'

ENVIRONMENT_SETUP = """
export PATH="### home ###/bin":\$PATH
export MAKEFILES="### home ###/bin/Makefile"
"""
EOF

filter='^(bin/.*|LEGGIMI.txt|esercizio-[0-9]+/(Testo|(input|output|args)-[0-9]+)\.txt)$'
python -m tm.mkconf -vf "$filter" -b $tempdir/conf.py -u "$srcdir/registered_uids.tsv" $tempdir/bundle "${srcdir}-tm.py"

echocol "*** Generating the CU configuration file (base + tar + uids)..."

filter='^(bin/Makefile|esercizio-[0-9]+/(input|output|args)-.+\.txt)$'
python -m tm.mkconf -vf "$filter" -b "$srcdir/conf.py" $tempdir/bundle "${srcdir}-cu.py"

echocol "Cleanup temp dir..."

chmod -R u+rwX,go= $tempdir
rm -rf $tempdir
